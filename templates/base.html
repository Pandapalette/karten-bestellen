<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Karten-Bestellen{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#eef3ff; padding:0; margin:0; font-family:sans-serif; }
    nav { background:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    nav a { margin-left:10px; }
    .chat-popup {
        display:none;
        position:fixed;
        bottom:20px;
        right:20px;
        border:1px solid #ccc;
        background:#fff;
        width:350px;
        max-height:400px;
        border-radius:10px;
        box-shadow:0 4px 10px rgba(0,0,0,0.2);
        flex-direction:column;
    }
    .chat-header { background:#0d6efd; color:white; padding:10px; border-top-left-radius:10px; border-top-right-radius:10px; cursor:pointer; }
    .chat-messages { padding:10px; overflow-y:auto; flex:1; height:250px; }
    .chat-input { display:flex; }
    .chat-input input { flex:1; padding:8px; border:none; border-top:1px solid #ccc; }
    .chat-input button { background:#0d6efd; color:white; border:none; padding:0 15px; }
  </style>
  {% block head %}{% endblock %}
</head>
<body>

<nav>
  <div>
    <a href="{{ url_for('home') }}">Home</a>
    {% if 'user' in session %}
      <span class="badge bg-primary">Eingeloggt als {{ session['user'] }}</span>
    {% else %}
      <a class="btn btn-success btn-sm" href="{{ url_for('login') }}">Login</a>
      <a class="btn btn-secondary btn-sm" href="{{ url_for('register') }}">Register</a>
    {% endif %}
  </div>
  <div>
    <a class="btn btn-warning btn-sm" href="{{ url_for('preise') }}">Preise</a>
    {% if session.get('user') == 'Pandapalette' %}
      <a class="btn btn-danger btn-sm" href="{{ url_for('admin') }}">Admin</a>
    {% endif %}
  </div>
</nav>

<div class="container mt-4">
  {% block content %}{% endblock %}
</div>

<!-- Chat-Popup -->
<div id="chatPopup" class="chat-popup d-flex flex-column">
  <div class="chat-header" onclick="toggleChat()">ðŸ’¬ Chat <span id="chatTitle"></span> âœ–</div>
  <div class="chat-messages" id="chatMessages"></div>
  <form class="chat-input" id="chatForm" onsubmit="return sendMessage();">
    <input type="text" id="chatText" placeholder="Nachricht..." autocomplete="off">
    <button type="submit">Senden</button>
  </form>
</div>

<script>
  let chatOpen = false;
  let currentOrder = null;

  function toggleChat() {
    const chat = document.getElementById('chatPopup');
    chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
  }

  function openChat(orderNumber, username) {
    currentOrder = orderNumber;
    document.getElementById('chatTitle').innerText = `Karte ${orderNumber} (${username})`;
    document.getElementById('chatMessages').innerHTML = '';
    fetch(`/chat/${username}/${orderNumber}`)
      .then(res => res.json())
      .then(data => {
        const messagesDiv = document.getElementById('chatMessages');
        data.forEach(m => {
          const msg = document.createElement('div');
          msg.innerHTML = `<b>${m.user}</b>: ${m.text} <small class="text-muted">${m.time}</small>`;
          messagesDiv.appendChild(msg);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    document.getElementById('chatPopup').style.display = 'flex';
  }

  function sendMessage() {
    const text = document.getElementById('chatText').value;
    if (!text || !currentOrder) return false;

    fetch(`/chat/${currentOrder}/send`, {
      method: 'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ text })
    }).then(res=>res.json())
    .then(data=>{
      document.getElementById('chatText').value = '';
      openChat(currentOrder, data.username);
    });
    return false;
  }
</script>

{% block scripts %}{% endblock %}
</body>
</html>
